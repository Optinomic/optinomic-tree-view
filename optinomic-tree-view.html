<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="imports.html">
<!--
`optinomic-tree-view` 

## A simple Polymer wrapper around dhtmlxTree.

### Getting started
```
bower install --save Optinomic/optinomic-tree-view
```

### Credits & Documentation
- Credits: https://dhtmlx.com/
- Documentation: https://docs.dhtmlx.com/treeview__index.html


@demo demo/index.html
-->
<dom-module id="optinomic-tree-view">
    <template>
        <style>
        :host {
            display: block;
            --tree-view-height: 400px;
        }
        
        div#tree_container {
            position: relative;
            display: block;
            border: 1px solid #EEEEEE;
            width: 100%;
            height: var(--tree-view-height);
        }
        </style>
        <div id="tree_container" on-tap="_getSelected"></div>
    </template>
    <script>
    Polymer({

        is: 'optinomic-tree-view',

        properties: {
            data: {
                type: Object,
                value: {},
                observer: '_dataChanged'
            },

            selected: {
                type: Object,
                value: {},
                notify: true,
                reflectToAttribute: true
            },

            select: {
                type: String,
                value: "Start",
                observer: '_selectChanged'
            },
        },


        // --------------------------------
        // Actions
        // --------------------------------


        _getSelected: function() {

            var id = this.tree.getSelectedId();
            if (id != null) {

                var return_obj = {
                    "id": id,
                    "text": this.tree.getItemText(id),
                    "level": this.tree.getLevel(id),
                    "parent": this.tree.getParentId(id),
                    "sub": this.tree.getSubItems(id),
                    "userdata": this.tree.getUserData(id, "")
                };
                console.log('(tree) selected node: ', return_obj);

                this.set('selected', return_obj);

            };

        },


        _dataRefresh: function(data) {

            if (this.tree !== undefined) {
                this.tree.loadStruct(data);
                console.log('(tree) dataRefresh: ', this.data);
            };
        },


        _selectNode: function(id) {
            id = id || "Start";

            if (this.tree !== undefined) {
                this.tree.selectItem(id);
                this._getSelected();
                console.log('(tree) doSelect: ', id);
            };
        },

        // --------------------------------
        // Change Observers
        // --------------------------------


        _dataChanged: function() {

            if (this.data) {

                this._dataRefresh(this.data);
                //console.log('(tree) _dataChanged:', this.data);

            };
        },

        _selectChanged: function() {

            if (this.select) {

                this._selectNode(this.select);
                //console.log('(tree) _selectChanged:', this.select);

            };
        },


        // --------------------------------
        // Init
        // --------------------------------


        _treeInit: function() {
            var container = this.$.tree_container;
            console.log('(tree) Init:', container);
            this.tree = new dhtmlXTreeView(container);

            this._dataChanged();
            this._selectChanged();
        },


        // --------------------------------
        // Lifecycle
        // --------------------------------

        attached: function() {
            this._treeInit();
            //console.log('(tree) attached', this.offsetWidth, this.offsetHeight);
        },

    });
    </script>
</dom-module>
